<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>é–²è¦§ç”¨ ccfolia log getter</title>
    <style>
        .numbered-list {
          display: flex;
          flex-wrap: wrap;
          gap: 10px; /* é©å®œèª¿æ•´ */
        }
    
        .numbered-item {
          display: flex;
          align-items: start;
        }
    
        .number {
          width: auto; /* ç•ªå·éƒ¨åˆ†ã®å¹… */
          text-align: right; /* ChatGPTå›å„ªç§€ã™ãã¦é ­ãŠã‹ã—ããªã‚Šãã†é ­ãŠã‹ã—ããªã‚Šãã†é ­ãŠã‹ã—ããªã‚Šãã† */
        }

        .numbered-item p {
            margin-top: 0;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>

var request = new XMLHttpRequest(),
    message_json = [],
    tab_list = {},
    current_room_id = '';

const RET = '\x0a',  // æ”¹è¡Œ
      CRLF = '\x0d\x0a';  // ã‚­ãƒ£ãƒªãƒƒã‚¸ãƒªã‚¿ãƒ¼ãƒ³ + æ”¹è¡Œ

// HTMLå†…ã®ç‰¹æ®Šæ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹é–¢æ•°
function htmlspecialchars(str) {
    return (str + '')
        .replace(/&/g, '&amp;')  // &ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        .replace(/"/g, '&quot;')  // "ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        .replace(/'/g, '&#039;')  // 'ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        .replace(/</g, '&lt;')    // <ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        .replace(/>/g, '&gt;');   // >ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
}

// ç‰¹æ®Šæ–‡å­—ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
function removespecialchars(str) {
    return (str + '')
        .replace(/&/g, 'removeamp')  // &ã‚’å‰Šé™¤
        .replace(/"/g, 'removequot')  // "ã‚’å‰Šé™¤
        .replace(/'/g, 'removeslash')  // 'ã‚’å‰Šé™¤
        .replace(/</g, 'removelt')  // <ã‚’å‰Šé™¤
        .replace(/>/g, 'removegt')  // >ã‚’å‰Šé™¤
        .replace(/ /g, 'removespace')  // ç©ºç™½ã‚’å‰Šé™¤
        .replace(/\//g, 'remove039');  // /ã‚’å‰Šé™¤
}

// ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå†…ã®ãƒã‚¹ãƒˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function get_property(obj, keys) {
    for (const key of keys) {
        if (key in obj) {
            obj = obj[key];
        } else {
            return null;
        }
    }
    return obj;
}

// Firestoreãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãŸã‚ã®URLã‚’æ§‹ç¯‰ã™ã‚‹é–¢æ•°
function get_url(room_id, page_token = '', page_size = 300) {
    return `https://firestore.googleapis.com/v1/projects/ccfolia-160aa/databases/(default)/documents/rooms/${room_id}/messages/?pageSize=${page_size}&pageToken=${page_token}`;
}

// ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ã‚¿ãƒ–ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function get_current_tab() {
    return $('[name="html_selector"]:radio:checked').val();
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†ã—ã¦è¡¨ç¤ºã™ã‚‹é–¢æ•°
function process_messages(messages) {
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆæ—¥æ™‚ã§ã‚½ãƒ¼ãƒˆ
    messages.sort((a, b) => {
        return a.createTime < b.createTime ? -1 : 1;
    });

    console.log(Number($('#text_start').val()));

    messages.forEach((message, index, array) => {
        array[index].number = index + 1;
    });

    let start = Number($('#text_start').val()),
        end = Number($('#text_end').val());

    // è¡¨ç¤ºç¯„å›²ã‚’æ±ºå®š
    let filtered_messages = (!isNaN(start) && start !== '' && !isNaN(end) && end !== '') 
        ? messages.slice(start - 1, end) 
        : messages.slice(-start);

    tab_list = {};
    var dom_elements = {},
        $container = $('<div></div>', { id: 'log_container' });

    $('#progress').html('');
    $('#html_selector').html('');

    // å…¨ä»¶è¡¨ç¤ºç”¨ã®ã‚¿ãƒ–ã‚’è¿½åŠ 
    tab_list['all'] = 'å…¨ä»¶';
    dom_elements['all'] = $('<div></div>', { id: '__tab__all' });
    $('#html_selector')
        .append($('<input>', { type: 'radio', name: 'html_selector', value: 'all', checked: true }))
        .append($('<label>', { for: 'all' }).html('å…¨ä»¶'));

    // å„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†ã—ã€DOMã«è¿½åŠ 
    filtered_messages.forEach(function (message) {
        const channel = removespecialchars(message.fields.channelName.stringValue),
              channel_name = message.fields.channelName.stringValue,
              from_name = message.fields.from.stringValue;  // é€ä¿¡è€…ã®åå‰ã‚’å–å¾—

        // ãƒãƒ£ãƒ³ãƒãƒ«ã”ã¨ã«æ–°ã—ã„ã‚¿ãƒ–ã‚’ä½œæˆï¼ˆæ—¢ã«å­˜åœ¨ã—ãªã„å ´åˆã®ã¿ï¼‰
        if (!(channel in tab_list)) {
            tab_list[channel] = channel_name;
            dom_elements[channel] = $('<div></div>', { id: `__tab__${channel}` });
            $('#html_selector')
                .append($('<input>', { type: 'radio', name: 'html_selector', value: channel }))
                .append($('<label>', { for: channel }).html(channel_name));
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¨å†…å®¹ã®å‡¦ç†
        let formatted_message = htmlspecialchars(message.fields.text.stringValue).replace(/\r?\n/, '');
        let message_color = message.fields.color.stringValue;

        // from.stringValueï¼ˆé€ä¿¡è€…åï¼‰ã‚’nameã®æ¨ªã«è¿½åŠ ã—ã¦ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        let message_html = `
            <div>
                <span style="color:${message_color}">${message.number}: ${channel_name} (${from_name})</span>
                <p>${formatted_message}</p>
            </div>`;
        
        $(dom_elements[channel]).append(message_html);
    });

    // ã™ã¹ã¦ã®DOMè¦ç´ ã‚’ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ 
    for (const channel in dom_elements) {
        $('#log_container').append(dom_elements[channel]);
        if (channel !== 'all') {
            $(`#__tab__${channel}`).hide();
        }
    }

    // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
    $('input[name="html_selector"]').change(function () {
        const current_tab = get_current_tab();
        for (const channel in tab_list) {
            if (channel === current_tab) {
                $(`#__tab__${channel}`).show();
            } else {
                $(`#__tab__${channel}`).hide();
            }
        }
    });

    $('#progress').html('å®Œäº†');
}

// HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
function http_request_callback() {
    console.log(this);
    const response = this.response;

    for (const document of response.documents) {
        message_json.push(document);
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã®è¡¨ç¤ºã‚’æ›´æ–°
    $('#message_num').html(`${message_json.length}ä»¶`);

    // æ¬¡ã®ãƒšãƒ¼ã‚¸ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Œã°ç¶šã‘ã¦å–å¾—
    if (response.nextPageToken) {
        this.open('GET', get_url(current_room_id, response.nextPageToken), true);
        this.responseType = 'json';
        this.send();
    } else {
        $('#progress').html('HTMLç”Ÿæˆä¸­...');
        setTimeout(() => {
            process_messages(message_json);
        }, 1);
        this.removeEventListener('load', http_request_callback);
    }
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
$(function () {
    $('#get_log').click(function () {
        // é–‹å§‹ä½ç½®ã¨çµ‚äº†ä½ç½®ã®å€¤ãŒæ­£ã—ã„ã‹ç¢ºèª
        if (isNaN(Number($('#text_start').val())) && $('#text_start').val() !== '') {
            window.alert('é–‹å§‹ä½ç½®orè¡¨ç¤ºä»¶æ•°ã®å€¤ãŒğŸŒˆ');
            return;
        }

        if (isNaN(Number($('#text_end').val())) && $('#text_end').val() !== '') {
            window.alert('çµ‚äº†ä½ç½®ã®å€¤ãŒğŸŒˆ');
            return;
        }

        // é€²è¡ŒçŠ¶æ³ã‚’ã€Œå–å¾—ä¸­ã€ã«æ›´æ–°
        $('#progress').html('å–å¾—ä¸­...');
        current_room_id = $('#room_id').val();
        document.title = `${current_room_id} ccfolia log getter`;

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
        message_json.splice(0, message_json.length);
        request.open('GET', get_url(current_room_id), true);
        request.responseType = 'json';
        request.send();

        request.addEventListener('load', http_request_callback);
    });
});

    </script>
</head>

<body>
    <header style="background: #ffffff;position: fixed; ">
    <input type="text" id="room_id" placeholder="ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›">
    <input type="text" id="text_start" placeholder="é–‹å§‹ä½ç½®orè¡¨ç¤ºä»¶æ•°">
    -
    <input type="text" id="text_end" placeholder="ä¿®äº†ä½ç½®">
    <input type="button" id="get_log" value="ãƒ­ã‚°ã‚’å–å¾—">
        <span id="progress"></span>
        <span id="log_number"></span>
        <form id="html_selector" style="height:50px; overflow: auto;"></form>
    </header>
    <div>

    </div>
    
    <div id="html" style="padding-top: 80px;"></div>
    <br>å·¦æ ã«å“IDã€å³ã«è¡¨ç¤ºæ•°ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚
    <br>0ã§å…¨ä»¶è¡¨ç¤ºå¯èƒ½ã§ã™ã€‚
    <br>ver1.001: é–‹å§‹ä½ç½®çµ‚äº†ä½ç½®ã®æŒ‡å®šå¯ã€idè¡¨ç¤ºonã€ãƒ€ã‚¤ã‚¹å¯¾å¿œã€ã‚¿ãƒ–è¡¨ç¤ºæ”¹å–„ä¸­ï¼Ÿ
    

</body>

</html>
