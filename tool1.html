<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>閲覧用 ccfolia log getter</title>
    <style>
        .tab-content {
            display: none;
        }

        .active-tab {
            display: block;
        }

        .message-container {
            margin-bottom: 10px;
        }

        .name-with-from {
            font-weight: bold;
        }

        .message-content {
            margin-left: 20px;
            color: black;
            white-space: pre-wrap; /* 改行を再現 */
        }

        .message-header {
            font-weight: bold;
        }

        /* タブを横に並べるスタイル */
        .tabs {
            display: flex;
            margin-bottom: 10px;
            gap: 10px;
        }

        .tabs input[type="radio"] {
            display: none;
        }

        .tabs label {
            padding: 5px 10px;
            background-color: #ddd;
            cursor: pointer;
        }

        .tabs input[type="radio"]:checked + label {
            background-color: #aaa;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>

        var request = new XMLHttpRequest();
        var message_json = [];
        var tab_list = {};
        var current_room_id = '';

        // 現在選択されているタブを取得する関数
        function get_current_tab() {
            return $('[name="html_selector"]:radio:checked').val();
        }

        // HTML特殊文字をエスケープ
        function htmlspecialchars(text) {
            return (text + '').replace(/&/g, '&amp;')
                             .replace(/"/g, '&quot;')
                             .replace(/'/g, '&#039;')
                             .replace(/</g, '&lt;')
                             .replace(/>/g, '&gt;');
        }

        // 特殊文字を除去
        function removespecialchars(text) {
            return (text + '').replace(/&/g, 'removeamp')
                              .replace(/"/g, 'removequot')
                              .replace(/'/g, 'remove039')
                              .replace(/</g, 'removelt')
                              .replace(/>/g, 'removegt')
                              .replace(/ /g, 'removespace')
                              .replace(/\//g, 'removeslash');
        }

        // APIのURLを生成する関数
        function get_url(room_id, pageToken = '', pageSize = 300) {
            const baseUrl = 'https://firestore.googleapis.com/v1/projects/ccfolia-160aa/databases/(default)/documents/rooms/';
            return baseUrl + room_id + '/messages/?pageSize=' + pageSize + '&pageToken=' + pageToken;
        }

        // メッセージを処理して表示する関数
        function process_messages(messages) {
            // メッセージを作成日時でソート
            messages.sort((a, b) => {
                return a.createTime < b.createTime ? -1 : 1;
            });

            // メッセージに番号を付与
            messages.forEach((message, index) => {
                message.number = index + 1;
            });

            // 表示範囲を設定
            let start = Number($('#text_start').val());
            let end = Number($('#text_end').val());

            // メッセージのフィルタリング
            let filtered_messages = (!isNaN(start) && start !== '' && !isNaN(end) && end !== '')
                ? messages.slice(start - 1, end)
                : messages.slice(-start);

            tab_list = {};
            var dom_elements = {};
            var $container = $('<div></div>', { id: 'log_container' });

            $('#progress').html('');
            $('#html_selector').html('');

            // 全件表示タブを追加
            tab_list['all'] = '全件';
            dom_elements['all'] = $('<div></div>', { id: '__tab__all' });
            $('#html_selector')
                .append($('<input>', { type: 'radio', name: 'html_selector', value: 'all', checked: true }))
                .append($('<label>', { for: 'all' }).html('全件'));

            // 各メッセージを処理し、DOMに追加
            filtered_messages.forEach(function (message) {
                const channel = message.fields.channelName ? message.fields.channelName.stringValue : 'undefined';
                const channel_name = message.fields.channelName ? message.fields.channelName.stringValue : '未分類';

                // チャンネルごとに新しいタブを作成（既に存在しない場合）
                if (!(channel in tab_list)) {
                    tab_list[channel] = channel_name;
                    dom_elements[channel] = $('<div></div>', { id: `__tab__${channel}` });
                    $('#html_selector')
                        .append($('<input>', { type: 'radio', name: 'html_selector', value: channel }))
                        .append($('<label>', { for: channel }).html(channel_name));
                }

                // メッセージのフォーマットと内容の処理
                let formatted_message = (message.fields.text && message.fields.text.stringValue) ?
                    htmlspecialchars(message.fields.text.stringValue).replace(/\r?\n/, '') : "（テキストなし）";
                let message_color = (message.fields.color && message.fields.color.stringValue) ? message.fields.color.stringValue : '#000';

                // フォーマットされたメッセージを追加
                let message_html = `
                    <div>
                        <span style="color:${message_color}">${message.number}: ${channel_name}</span>
                        <p>${formatted_message}</p>
                    </div>`;
                
                $(dom_elements[channel]).append(message_html);
                $(dom_elements['all']).append(message_html); // 全件表示用にもメッセージを追加
            });

            // すべてのDOM要素をコンテナに追加
            for (const channel in dom_elements) {
                $container.append(dom_elements[channel]);
                if (channel !== 'all') {
                    $(`#__tab__${channel}`).hide(); // 非表示にする
                }
            }

            // タブの表示切り替え
            $('input[name="html_selector"]').change(function () {
                const current_tab = get_current_tab();
                for (const channel in tab_list) {
                    if (channel === current_tab) {
                        $(`#__tab__${channel}`).show();
                    } else {
                        $(`#__tab__${channel}`).hide();
                    }
                }
            });

            // 完成したコンテナを表示
            $('#html').html($container);
            $('#progress').html('完了');
        }

        // HTTPリクエストのコールバック処理
        function http_request_callback() {
            const response = this.response;

            // メッセージを格納
            response.documents.forEach(function (doc) {
                message_json.push(doc);
            });

            // 次のページがあるか確認して、再度リクエストを送る
            if (response.nextPageToken) {
                this.open('GET', get_url(current_room_id, response.nextPageToken), true);
                this.responseType = 'json';
                this.send();
            } else {
                // 最後のページに到達したらメッセージを処理
                $('#progress').text('HTML生成中...');
                setTimeout(() => {
                    process_messages(message_json);
                }, 1);
                this.removeEventListener('load', http_request_callback);
            }
        }

        // DOMが準備されたらイベントリスナーを設定
        $(function() {
            $('#get_log').click(function() {
                const startText = $('#text_start').val();
                const endText = $('#text_end').val();

                // 入力チェック
                if (isNaN(Number(startText)) && startText !== '') {
                    alert('開始位置or表示件数の値が無効です');
                    return;
                }
                if (isNaN(Number(endText)) && endText !== '') {
                    alert('終了位置の値が無効です');
                    return;
                }

                $('#progress').text('取得中...');
                current_room_id = $('#room_id').val();
                document.title = current_room_id + ' ccfolia log getter';

                // メッセージデータの初期化
                message_json.splice(0, message_json.length);

                // APIリクエスト
                request.open('GET', get_url(current_room_id), true);
                request.responseType = 'json';
                request.send();

                request.addEventListener('load', http_request_callback);
            });
        });
    </script>
</head>

<body>
    <header style="background: #ffffff; position: fixed;">
        <input type="text" id="room_id" placeholder="ルームIDを入力">
        <input type="text" id="text_start" placeholder="開始位置or表示件数"> -
        <input type="text" id="text_end" placeholder="修了位置">
        <input type="button" id="get_log" value="ログを取得">
        <span id="progress"></span>
        <span id="log_number"></span>
        <div id="html_selector" class="tabs"></div>
    </header>
    
    <div id="html" style="padding-top: 80px;"></div>
    <br>左枠に卓ID、右に表示数を入れてください。
    <br>0で全件表示可能です。
    <br>ver1.192: 開始位置終了位置の指定可、id表示on、ダイス未対応、タブ表示改善しててか見えない
    

</body>

</html>
