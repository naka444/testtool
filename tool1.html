<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>閲覧用 ccfolia log getter</title>
    <style>
        .numbered-list {
          display: flex;
          flex-wrap: wrap;
          gap: 10px; /* 適宜調整 */
        }
    
        .numbered-item {
          display: flex;
          align-items: start;
        }
    
        .number {
          width: auto; /* 番号部分の幅 */
          text-align: right; /* ChatGPT君優秀すぎて頭おかしくなりそう頭おかしくなりそう頭おかしくなりそう */
        }

        .numbered-item p {
            margin-top: 0;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>

var request = new XMLHttpRequest(),
    message_json = [],
    tab_list = {},
    current_room_id = '';

const RET = '\x0a',  // 改行
      CRLF = '\x0d\x0a';  // キャリッジリターン + 改行

// HTML内の特殊文字をエスケープする関数
function htmlspecialchars(str) {
    return (str + '')
        .replace(/&/g, '&amp;')  // &をエスケープ
        .replace(/"/g, '&quot;')  // "をエスケープ
        .replace(/'/g, '&#039;')  // 'をエスケープ
        .replace(/</g, '&lt;')    // <をエスケープ
        .replace(/>/g, '&gt;');   // >をエスケープ
}

// 特殊文字を削除する関数
function removespecialchars(str) {
    return (str + '')
        .replace(/&/g, 'removeamp')  // &を削除
        .replace(/"/g, 'removequot')  // "を削除
        .replace(/'/g, 'removeslash')  // 'を削除
        .replace(/</g, 'removelt')  // <を削除
        .replace(/>/g, 'removegt')  // >を削除
        .replace(/ /g, 'removespace')  // 空白を削除
        .replace(/\//g, 'remove039');  // /を削除
}

// オブジェクト内のネストされたプロパティを取得する関数
function get_property(obj, keys) {
    for (const key of keys) {
        if (key in obj) {
            obj = obj[key];
        } else {
            return null;
        }
    }
    return obj;
}

// FirestoreリクエストのためのURLを構築する関数
function get_url(room_id, page_token = '', page_size = 300) {
    return `https://firestore.googleapis.com/v1/projects/ccfolia-160aa/databases/(default)/documents/rooms/${room_id}/messages/?pageSize=${page_size}&pageToken=${page_token}`;
}

// 現在選択されているタブを取得する関数
function get_current_tab() {
    return $('[name="html_selector"]:radio:checked').val();
}

// メッセージを処理して表示する関数
function process_messages(messages) {
    // メッセージを作成日時でソート
    messages.sort((a, b) => {
        return a.createTime < b.createTime ? -1 : 1;
    });

    console.log(Number($('#text_start').val()));

    messages.forEach((message, index, array) => {
        array[index].number = index + 1;
    });

    let start = Number($('#text_start').val()),
        end = Number($('#text_end').val());

    // 表示範囲を決定
    let filtered_messages = (!isNaN(start) && start !== '' && !isNaN(end) && end !== '') 
        ? messages.slice(start - 1, end) 
        : messages.slice(-start);

    tab_list = {};
    var dom_elements = {},
        $container = $('<div></div>', { id: 'log_container' });

    $('#progress').html('');
    $('#html_selector').html('');

    // 全件表示用のタブを追加
    tab_list['all'] = '全件';
    dom_elements['all'] = $('<div></div>', { id: '__tab__all' });
    $('#html_selector')
        .append($('<input>', { type: 'radio', name: 'html_selector', value: 'all', checked: true }))
        .append($('<label>', { for: 'all' }).html('全件'));

    // 各メッセージを処理し、DOMに追加
    filtered_messages.forEach(function (message) {
        const channel = removespecialchars(message.fields.channelName.stringValue),
              channel_name = message.fields.channelName.stringValue,
              from_name = message.fields.from.stringValue;  // 送信者の名前を取得

        // チャンネルごとに新しいタブを作成（既に存在しない場合のみ）
        if (!(channel in tab_list)) {
            tab_list[channel] = channel_name;
            dom_elements[channel] = $('<div></div>', { id: `__tab__${channel}` });
            $('#html_selector')
                .append($('<input>', { type: 'radio', name: 'html_selector', value: channel }))
                .append($('<label>', { for: channel }).html(channel_name));
        }

        // メッセージのフォーマットと内容の処理
        let formatted_message = htmlspecialchars(message.fields.text.stringValue).replace(/\r?\n/, '');
        let message_color = message.fields.color.stringValue;

        // from.stringValue（送信者名）をnameの横に追加してフォーマット
        let message_html = `
            <div>
                <span style="color:${message_color}">${message.number}: ${channel_name} (${from_name})</span>
                <p>${formatted_message}</p>
            </div>`;
        
        $(dom_elements[channel]).append(message_html);
    });

    // すべてのDOM要素をコンテナに追加
    for (const channel in dom_elements) {
        $('#log_container').append(dom_elements[channel]);
        if (channel !== 'all') {
            $(`#__tab__${channel}`).hide();
        }
    }

    // 選択されたタブの表示を切り替える
    $('input[name="html_selector"]').change(function () {
        const current_tab = get_current_tab();
        for (const channel in tab_list) {
            if (channel === current_tab) {
                $(`#__tab__${channel}`).show();
            } else {
                $(`#__tab__${channel}`).hide();
            }
        }
    });

    $('#progress').html('完了');
}

// HTTPリクエストのコールバック関数
function http_request_callback() {
    console.log(this);
    const response = this.response;

    for (const document of response.documents) {
        message_json.push(document);
    }

    // メッセージ数の表示を更新
    $('#message_num').html(`${message_json.length}件`);

    // 次のページトークンがあれば続けて取得
    if (response.nextPageToken) {
        this.open('GET', get_url(current_room_id, response.nextPageToken), true);
        this.responseType = 'json';
        this.send();
    } else {
        $('#progress').html('HTML生成中...');
        setTimeout(() => {
            process_messages(message_json);
        }, 1);
        this.removeEventListener('load', http_request_callback);
    }
}

// ページ読み込み時の処理
$(function () {
    $('#get_log').click(function () {
        // 開始位置と終了位置の値が正しいか確認
        if (isNaN(Number($('#text_start').val())) && $('#text_start').val() !== '') {
            window.alert('開始位置or表示件数の値が🌈');
            return;
        }

        if (isNaN(Number($('#text_end').val())) && $('#text_end').val() !== '') {
            window.alert('終了位置の値が🌈');
            return;
        }

        // 進行状況を「取得中」に更新
        $('#progress').html('取得中...');
        current_room_id = $('#room_id').val();
        document.title = `${current_room_id} ccfolia log getter`;

        // メッセージのリストを初期化してリクエストを送信
        message_json.splice(0, message_json.length);
        request.open('GET', get_url(current_room_id), true);
        request.responseType = 'json';
        request.send();

        request.addEventListener('load', http_request_callback);
    });
});

    </script>
</head>

<body>
    <header style="background: #ffffff;position: fixed; ">
    <input type="text" id="room_id" placeholder="ルームIDを入力">
    <input type="text" id="text_start" placeholder="開始位置or表示件数">
    -
    <input type="text" id="text_end" placeholder="修了位置">
    <input type="button" id="get_log" value="ログを取得">
        <span id="progress"></span>
        <span id="log_number"></span>
        <form id="html_selector" style="height:50px; overflow: auto;"></form>
    </header>
    <div>

    </div>
    
    <div id="html" style="padding-top: 80px;"></div>
    <br>左枠に卓ID、右に表示数を入れてください。
    <br>0で全件表示可能です。
    <br>ver1.001: 開始位置終了位置の指定可、id表示on、ダイス対応、タブ表示改善中？
    

</body>

</html>
