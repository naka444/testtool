<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>閲覧用 ccfolia</title>
    <style>
        .numbered-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
    
        .numbered-item {
            display: flex;
            align-items: start;
        }
    
        .number {
            width: auto;
            text-align: right;
        }
    
        .numbered-item p {
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div>
        <label for="room_id">ルームID:</label>
        <input type="text" id="room_id" value="">
        <button id="get_log">ログ取得</button>
        <button id="save_html">HTMLで保存</button>
    </div>
    <div id="progress">進捗状況: なし</div>
    <div id="log_number">ログ件数: 0</div>
    
    <div id="html_selector"></div>
    <div id="html"></div>

    <!-- jQueryを先にロード -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        // ユーザーからのデータを格納する変数
        var message_json = [];
        var current_room_id = '';

        function get_url(room_id, pageToken = '', pageSize = 300) {
            const base_url = 'https://firestore.googleapis.com/v1/projects/ccfolia-160aa/databases/(default)/documents/rooms/';
            return base_url + room_id + '/messages/' + '?pageSize=' + pageSize + '&pageToken=' + pageToken;
        }

        function process_messages(messages) {
            messages.forEach(function(message, index) {
                const message_html = `
                    <div class="numbered-item" style="color:${message.fields.color.stringValue};">
                        <div class="number">${index + 1}:</div>
                        <p>${message.fields.text.stringValue}</p>
                    </div>`;
                $('#html').append(message_html);
            });
            $('#progress').text('完了');
        }

        function http_request_callback() {
            const response = this.response;
            for (const document of response.documents) {
                message_json.push(document);
            }
            $('#log_number').text(message_json.length + '件');
            process_messages(message_json);
        }

        $(document).ready(function() {
            // ログ取得ボタンのイベント
            $('#get_log').click(function() {
                const room_id = $('#room_id').val();
                if (!room_id) {
                    alert('ルームIDを入力してください');
                    return;
                }
                current_room_id = room_id;
                $('#progress').text('取得中...');
                message_json = [];
                const request = new XMLHttpRequest();
                request.open('GET', get_url(current_room_id), true);
                request.responseType = 'json';
                request.send();
                request.addEventListener('load', http_request_callback);
            });

            // HTML保存機能
            $('#save_html').click(function() {
                var content = $('#html').html();
                var fullHtml = `
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>CCFolia Log</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .numbered-item { margin-bottom: 10px; }
        .number { font-weight: bold; }
    </style>
</head>
<body>
    <h1>CCFolia Log</h1>
    ${content}
</body>
</html>
                `;
                var blob = new Blob([fullHtml], {type: "text/html;charset=utf-8"});
                var link = document.createElement("a");
                var url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "ccfolia_log.html");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        });
    </script>
</body>
</html>
