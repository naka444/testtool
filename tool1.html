<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>閲覧用 ccfolia log getter</title>
    <style>
        .tab-content {
            display: none;
        }

        .active-tab {
            display: block;
        }

        .message-container {
            margin-bottom: 10px;
        }

        .name-with-from {
            font-weight: bold;
        }

        .message-content {
            margin-left: 20px;
            color: black;
            white-space: pre-wrap; /* 改行を再現 */
        }

        .message-header {
            font-weight: bold;
        }

        /* タブを横に並べるスタイル */
        .tabs {
            display: flex;
            margin-bottom: 10px;
            gap: 10px;
        }

        .tabs input[type="radio"] {
            display: none;
        }

        .tabs label {
            padding: 5px 10px;
            background-color: #ddd;
            cursor: pointer;
        }

        .tabs input[type="radio"]:checked + label {
            background-color: #aaa;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>

        var request = new XMLHttpRequest();
        var message_json = [];
        var tab_list = {};
        var current_room_id = '';

        // HTML特殊文字をエスケープ
        function htmlspecialchars(text) {
            return (text + '').replace(/&/g, '&amp;')
                             .replace(/"/g, '&quot;')
                             .replace(/'/g, '&#039;')
                             .replace(/</g, '&lt;')
                             .replace(/>/g, '&gt;');
        }

        // 特殊文字を除去
        function removespecialchars(text) {
            return (text + '').replace(/&/g, 'removeamp')
                              .replace(/"/g, 'removequot')
                              .replace(/'/g, 'remove039')
                              .replace(/</g, 'removelt')
                              .replace(/>/g, 'removegt')
                              .replace(/ /g, 'removespace')
                              .replace(/\//g, 'removeslash');
        }

        // 特殊文字をエスケープしてIDとして使用可能な形式に変換
        function escapeId(id) {
            return id.replace(/[^a-zA-Z0-9]/g, '_');
        }

        // APIのURLを生成する関数
        function get_url(room_id, pageToken = '', pageSize = 300) {
            const baseUrl = 'https://firestore.googleapis.com/v1/projects/ccfolia-160aa/databases/(default)/documents/rooms/';
            return baseUrl + room_id + '/messages/?pageSize=' + pageSize + '&pageToken=' + pageToken;
        }

        // メッセージを処理して表示する関数
        function process_messages(messages) {
            // メッセージを日時順にソート
            messages.sort(function(a, b) {
                return new Date(a.createTime) - new Date(b.createTime);
            });

            messages.forEach(function(message, index) {
                message.number = index + 1;  // 番号付けは内部的に管理
            });

            var fromValue;

            // メッセージをHTMLに整形して表示
            var allMessages = '';
            tab_list = {}; // 前回のデータをクリア

            messages.forEach(function(message) {
                // `fields` の存在確認を追加
                if (!message.fields) {
                    console.warn('Message without fields:', message);
                    return;  // fieldsがない場合はスキップ
                }

                // `from.stringValue` の最初の5桁を取得
                if (message.fields.from && message.fields.from.stringValue) {
                    fromValue = message.fields.from.stringValue.slice(0, 5);  // 最初の5桁
                } else {
                    fromValue = "N/A";  // `from` フィールドがない場合
                }

                // 各フィールドの存在を確認しつつ処理
                const channelId = message.fields.channel ? removespecialchars(message.fields.channel.stringValue) : 'undefined'; // チャンネル情報
                const escapedChannelId = escapeId(channelId);  // エスケープしてIDとして使用可能に
                const channelName = message.fields.channelName ? message.fields.channelName.stringValue : '未分類'; // チャンネル名
                const messageText = message.fields.text && message.fields.text.stringValue ? htmlspecialchars(message.fields.text.stringValue).replace(/\n/g, "<br>") : "（テキストなし）";
                const messageColor = message.fields.color ? message.fields.color.stringValue : "#000";
                const messageName = message.fields.name ? message.fields.name.stringValue : "名無し";

                // extendにresultが存在すれば追加
                let resultText = "";
                if (message.fields.extend && message.fields.extend.mapValue.fields &&
                    message.fields.extend.mapValue.fields.roll &&
                    message.fields.extend.mapValue.fields.roll.mapValue.fields.result) {
                    resultText = `<div class="message-result">Result: ${htmlspecialchars(message.fields.extend.mapValue.fields.roll.mapValue.fields.result.stringValue)}</div>`;
                }

                // 表示用の文字列を構築
                let displayString = `<div class="message-container">`;
                displayString += `<span class="message-header" style="color:${messageColor};">${message.number}: ${messageName} (${fromValue}) [${channelName}]</span><br>`;
                displayString += `<span class="message-content">${messageText}</span>`;
                if (resultText) {
                    displayString += resultText;
                }
                displayString += '</div>';

                // 各チャンネルごとにタブを生成
                if (!tab_list[escapedChannelId]) {
                    tab_list[escapedChannelId] = '';
                }
                tab_list[escapedChannelId] += displayString;

                // 全メッセージに追加
                allMessages += displayString;
            });

            // タブごとに内容を表示
            $('#html').html('');  // 既存の内容をクリア
            $('#html_selector').html('');  // 既存のタブをクリア
            $('#html').append('<div id="tab-all" class="tab-content active-tab">' + allMessages + '</div>');

            for (const escapedChannelId in tab_list) {
                const originalChannelId = Object.keys(tab_list).find(key => escapeId(key) === escapedChannelId);  // エスケープ前のIDを探す
                const channelName = messages.find(m => removespecialchars(m.fields.channel.stringValue) === originalChannelId).fields.channelName.stringValue;

                console.log("Generating tab div for escapedChannelId: " + escapedChannelId + ", channelName: " + channelName);

                $('#html').append('<div id="tab-' + escapedChannelId + '" class="tab-content">' + tab_list[escapedChannelId] + '</div>');
                $('#html_selector').append(`
                    <input type="radio" name="html_selector" value="${escapedChannelId}" id="tab-${escapedChannelId}">
                    <label for="tab-${escapedChannelId}">${channelName}</label>
                `);
            }

            // 全体表示タブも追加
            $('#html_selector').prepend(`
                <input type="radio" name="html_selector" value="all" id="tab-all" checked>
                <label for="tab-all">全件</label>
            `);

            $('#progress').text(''); // 完了時にプログレス表示を消す
        }

        // HTTPリクエストのコールバック処理
        function http_request_callback() {
            const response = this.response;

            // メッセージを格納
            response.documents.forEach(function(doc) {
                message_json.push(doc);
            });

            // 次のページがあるか確認して、再度リクエストを送る
            if (response.nextPageToken) {
                this.open('GET', get_url(current_room_id, response.nextPageToken), true);
                this.responseType = 'json';
                this.send();
            } else {
                // 最後のページに到達したらメッセージを処理
                $('#progress').text('HTML生成中...');
                setTimeout(() => {
                    process_messages(message_json);
                }, 1);
                this.removeEventListener('load', http_request_callback);
            }
        }

        // DOMが準備されたらイベントリスナーを設定
        $(function() {
            $('#get_log').click(function() {
                const startText = $('#text_start').val();
                const endText = $('#text_end').val();

                // 入力チェック
                if (isNaN(Number(startText)) && startText !== '') {
                    alert('開始位置or表示件数の値が無効です');
                    return;
                }
                if (isNaN(Number(endText)) && endText !== '') {
                    alert('終了位置の値が無効です');
                    return;
                }

                $('#progress').text('取得中...');
                current_room_id = $('#room_id').val();
                document.title = current_room_id + ' ccfolia log getter';

                // メッセージデータの初期化
                message_json.splice(0, message_json.length);

                // APIリクエスト
                request.open('GET', get_url(current_room_id), true);
                request.responseType = 'json';
                request.send();

                request.addEventListener('load', http_request_callback);
            });

            // タブ切り替えイベント
            $('#html_selector').on('change', 'input[name="html_selector"]', function() {
                const selectedTab = $('input[name="html_selector"]:checked').val();
                
                console.log("Selected tab: " + selectedTab);

                $('.tab-content').removeClass('active-tab').hide(); // Hide all
                $('#tab-' + selectedTab).addClass('active-tab').show(); // Show selected tab
            });
        });
    </script>
</head>

<body>
    <header style="background: #ffffff; position: fixed;">
        <input type="text" id="room_id" placeholder="ルームIDを入力">
        <input type="text" id="text_start" placeholder="開始位置or表示件数"> -
        <input type="text" id="text_end" placeholder="修了位置">
        <input type="button" id="get_log" value="ログを取得">
        <span id="progress"></span>
        <span id="log_number"></span>
        <div id="html_selector" class="tabs"></div>
    </header>
    
    <div id="html" style="padding-top: 80px;"></div>
    <br>左枠に卓ID、右に表示数を入れてください。
    <br>0で全件表示可能です。
    <br>ver1.198: 開始位置終了位置の指定可、id表示on、ダイス対応、タブ表示改善中
    

</body>

</html>
