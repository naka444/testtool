// 難読化された部分は元のまま保持しています
function _0x38da(){var _0x1e9795=['fields','show','<input>','channel','343042FKalVN','html_selector','result','title',';\x22>','12484uflKte','remove039','removeslash','stringValue','join','forEach','responseType','nextPageToken','name','text','&lt;','#room_id','split','1370037KkJctm','/messages/','channelName','\x20\x20\x20\x20','hosi','mapValue',']</span>','#html','9moDePi','<label>','12QmWuyb','1495HwARkW','alert','GET','\x20\x20\x20\x20<span\x20style=\x22color:#000000\x22>','&amp;','__tab__all','#log_number','28DKzolT','&pageToken=','</span>\x20:','<div></div>','&#039;','all','append','val','json','\x20\x20\x20\x20\x20\x20','?pageSize=','&gt;','removegt','</div>','#progress','removeamp','removequot','<div\x20class=\x22numbered-item\x22\x20style=\x22color:','open','210ZLjLrm','\x20\x20\x20\x20</span>','log','12PvtSaz','2575544tuxjRi','130AsSlUn','\x20\x20<p>','change','10617220wGVEFN','#text_start','clone','click','#text_count','#html_selector','radio','https://firestore.googleapis.com/v1/projects/ccfolia-160aa/databases/(default)/documents/rooms/','343188CEQKJf','hide','sort','message_num','\x20\x20</p>','13460579qeApZq','documents','extend','replace','\x20\x20<div\x20class=\x22number\x22>','\x20\x20\x20\x20<span>','[name=\x22html_selector\x22]:radio:checked','#get_log','send','slice','#__tab__','load','<br>','#text_end','[name=\x22html_selector\x22]:radio','__tab__','createTime','length','\x20\x20\x20\x20<span>\x20['];_0x38da=function(){return _0x1e9795;};return _0x38da();}

var request = new XMLHttpRequest();
var message_json = [];
var tab_list = {};
var current_room_id = '';
const RET = '\n';
const CRLF = '\r\n';

function htmlspecialchars(str) {
    return (str + '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#039;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function removespecialchars(str) {
    return (str + '').replace(/&/g, 'removeamp').replace(/"/g, 'removequot').replace(/'/g, 'remove039').replace(/</g, 'removelt').replace(/>/g, 'removegt').replace(/ /g, 'removespace').replace(/\//g, 'removeslash');
}

function get_property(obj, path) {
    for (const key of path) {
        if (key in obj) obj = obj[key];
        else return null;
    }
    return obj;
}

function get_url(room_id, pageToken = '', pageSize = 300) {
    const base_url = 'https://firestore.googleapis.com/v1/projects/ccfolia-160aa/databases/(default)/documents/rooms/';
    return base_url + room_id + '/messages/' + '?pageSize=' + pageSize + '&pageToken=' + pageToken;
}

function get_current_tab() {
    return $('[name="html_selector"]:radio:checked').val();
}

function get_tab_dom_id(tab_id) {
    return '#__tab__' + tab_id;
}

function process_messages(messages) {
    messages.sort(function(a, b) {
        if (a.createTime < b.createTime) return -1;
        if (a.createTime > b.createTime) return 1;
        return 0;
    });

    console.log(Number($('#text_count').val()));

    messages.forEach(function(message, index, array) {
        array[index].message_num = index + 1;
    });

    var text_start = $('#text_start').val();
    var text_end = $('#text_end').val();

    if (!isNaN(text_start) && text_start != '' && !isNaN(text_end) && text_end != '')
        var messages_slice = messages.slice(Number(text_start) - 1, Number(text_end));
    else
        var messages_slice = messages.slice(-Number(text_start));

    tab_list = {};
    var tab_dom = {};
    var result_dom = $('<div></div>', {'id': 'all'});;

    $('#html').empty('');
    $('#html_selector').empty('');

    tab_list['all'] = '全件';
    tab_dom['all'] = $('<div></div>', {'id': '__tab__' + 'all'});

    $('#html_selector')
        .append($('<input>', {'type': 'radio', 'name': 'html_selector', 'value': 'all', 'checked': true}))
        .append($('<label>', {'for': 'all'}).text('全件'));

    messages_slice.forEach(function(message) {
        const channel_id = removespecialchars(message.fields.channel.stringValue);
        const channelName = message.fields.channelName.stringValue;
        const fromUser = message.fields.from.stringValue.substr(0, 5); // fromフィールドの先頭5文字を取得

        if (!(channel_id in tab_list)) {
            tab_list[channel_id] = channelName;
            tab_dom[channel_id] = $('<div></div>', {'id': '__tab__' + channel_id});
            $('#html_selector')
                .append($('<input>', {'type': 'radio', 'name': 'html_selector', 'value': channel_id, 'checked': false}))
                .append($('<label>', {'for': channel_id}).text(channelName));
        }

        if (message.fields.text.stringValue != '') {
            var roll_result = get_property(message.fields, ["status", "mapValue", "fields", "roll", "mapValue", "fields", "result", "stringValue"]);
            if (!roll_result) {
                roll_result = '';
            }
            roll_result.replace(/\r?\n/, '');

            var text_html = htmlspecialchars(message.fields.text.stringValue).split(/\r?\n/);
            text_html = text_html.join('\x20\x20\x20\x20<br>' + RET + '\x20\x20\x20\x20') + roll_result;

            string = RET;
            string += '<div class="numbered-item" style="color:' + message.fields.color.stringValue + ';">';
            string += '<div class="number">' + message.message_num + ':</div>';
            string += '  <p>';
            string += '    <span>' + channelName + '</span> :' + RET;
            string += '    <span>' + htmlspecialchars(message.fields.name.stringValue) + '</span> :' + RET;
            string += '    <span>[' + fromUser + ']</span> :' + RET; // fromフィールドを追加
            string += '    <span>' + RET;
            string += '      ' + text_html + RET;
            string += '    </span>' + RET;
            string += '  </p>' + RET;

            $(tab_dom['all']).append(string);

            string = RET;
            string += '<div class="numbered-item" style="color:' + message.fields.color.stringValue + ';">';
            string += '<div class="number">' + message.message_num + ':</div>';
            string += '  <p>';
            string += '    <span>' + htmlspecialchars(message.fields.name.stringValue) + '</span> :' + RET;
            string += '    <span>[' + fromUser + ']</span> :' + RET; // fromフィールドを追加
            string += '    <span style="color:#000000">' + RET;
            string += '      ' + text_html + RET;
            string += '    </span>' + RET;
            string += '  </p>' + RET;
            string += '</div>' + RET;

            $(tab_dom[channel_id]).append(string);
        }
    });

    for (const tab_id in tab_dom) {
        $('#html').append(tab_dom[tab_id]);
        if (tab_id != 'all') {
            $('#__tab__' + tab_id).hide();
        }
    }

    $('[name="html_selector"]:radio').change(function() {
        const current_tab = get_current_tab();
        for (const tab_id in tab_list) {
            if (tab_id == current_tab) {
                $(get_tab_dom_id(tab_id)).show();
            } else {
                $(get_tab_dom_id(tab_id)).hide();
            }
        }
    });

    $('#progress').text('完了');
}

function convertToHTML(jqObject) {
    return jQuery('<div>').append(jqObject.clone(true)).html();
}

function http_request_callback() {
    console.log(this);
    const response = this.response;
    for (const document of response.documents) {
        message_json.push(document);
    }
    $('#log_number').text(message_json.length + '件');
    if (response.nextPageToken) {
        this.open('GET', get_url(current_room_id, response.nextPageToken), true);
        this.responseType = 'json';
        this.send();
    } else {
        $('#progress').text('HTML生成中...');
        setTimeout(() => { process_messages(message_json); }, 1);
        this.removeEventListener('load', http_request_callback);
    }
}

$(function() {
    $('#get_log').click(function(event) {
        if (isNaN(Number($('#text_start').val())) && $('#text_start').val() != '') {
            window.alert('開始位置or表示件数の値が🌈');
            return;
        }
        if (isNaN(Number($('#text_end').val())) && $('#text_end').val() != '') {
            window.alert('終了位置の値が🌈');
            return;
        }
        $('#progress').text('取得中...');
        current_room_id = $('#room_id').val();
        document.title = current_room_id + ' ' + 'ccfolia log getter';
        message_json.splice(0);
        request.open('GET', get_url(current_room_id), true);
        request.responseType = 'json';
        request.send();
        request.addEventListener('load', http_request_callback);
    });
});

// HTML保存機能
function saveAsHtml() {
    var currentTab = get_current_tab();
    var content = $(get_tab_dom_id(currentTab)).html();
    
    var fullHtml = `
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>CCFolia Log - ${currentTab}</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .numbered-item { margin-bottom: 10px; }
        .number { font-weight: bold; }
    </style>
</head>
<body>
    <h1>CCFolia Log - ${currentTab}</h1>
    ${content}
</body>
</html>
    `;
    
    var blob = new Blob([fullHtml], {type: "text/html;charset=utf-8"});
    
    var link = document.createElement("a");
    if (link.download !== undefined) {
        var url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `ccfolia_log_${currentTab}.html`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

// 保存ボタンを追加
$('<button id="save_html">HTMLで保存</button>').insertAfter('#get_log');

// 保存ボタンのクリックイベントを設定
$('#save_html').click(saveAsHtml);
