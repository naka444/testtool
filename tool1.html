<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>閲覧用 ccfolia log getter</title>
    <style>
        .numbered-list {
          display: flex;
          flex-wrap: wrap;
          gap: 10px; /* 適宜調整 */
        }
    
        .numbered-item {
          display: flex;
          align-items: start;
        }

        .tab-content {
          display: none;
        }

        .active-tab {
          display: block;
        }

        .number {
          width: auto;
          text-align: right;
        }

        .numbered-item p {
            margin-top: 0;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>

        var request = new XMLHttpRequest();
        var message_json = [];
        var tab_list = {};
        var current_room_id = '';

        const RET = '\n';

        // HTML特殊文字をエスケープ
        function htmlspecialchars(text) {
            return (text + '').replace(/&/g, '&amp;')
                             .replace(/"/g, '&quot;')
                             .replace(/'/g, '&#039;')
                             .replace(/</g, '&lt;')
                             .replace(/>/g, '&gt;');
        }

        // 特殊文字を除去
        function removespecialchars(text) {
            return (text + '').replace(/&/g, 'removeamp')
                              .replace(/"/g, 'removequot')
                              .replace(/'/g, 'remove039')
                              .replace(/</g, 'removelt')
                              .replace(/>/g, 'removegt')
                              .replace(/ /g, 'removespace')
                              .replace(/\//g, 'removeslash');
        }

        // プロパティを取得する関数
        function get_property(obj, props) {
            for (const prop of props) {
                if (prop in obj) {
                    obj = obj[prop];
                } else {
                    return null;
                }
            }
            return obj;
        }

        // APIのURLを生成する関数
        function get_url(room_id, pageToken = '', pageSize = 300) {
            const baseUrl = 'https://firestore.googleapis.com/v1/projects/ccfolia-160aa/databases/(default)/documents/rooms/';
            return baseUrl + room_id + '/messages/?pageSize=' + pageSize + '&pageToken=' + pageToken;
        }

        // メッセージを処理して表示する関数
        function process_messages(messages) {
            // メッセージを日時順にソート
            messages.sort(function(a, b) {
                return new Date(a.createTime) - new Date(b.createTime);
            });

            messages.forEach(function(message, index) {
                message.number = index + 1;  // 番号付けは内部的に管理
            });

            var fromValue;

            // メッセージをHTMLに整形して表示
            var allMessages = '';

            messages.forEach(function(message) {
                // `from.stringValue` の最初の5桁を取得
                if (message.fields.from && message.fields.from.stringValue) {
                    fromValue = message.fields.from.stringValue.slice(0, 5);  // 最初の5桁
                } else {
                    fromValue = "N/A";  // `from` フィールドがない場合
                }

                const channelId = removespecialchars(message.fields.channel.stringValue);
                const channelName = message.fields.channelName.stringValue;
                const messageText = htmlspecialchars(message.fields.text.stringValue);
                const messageColor = message.fields.color.stringValue;
                const messageName = message.fields.name.stringValue;

                // 表示用の文字列を構築
                let displayString = '';
                displayString += `From: ${fromValue}\n`;  // `from` の最初の5桁
                displayString += `チャンネル: ${channelName}\n`;
                displayString += `名前: ${messageName}\n`;
                displayString += `メッセージ: ${messageText}\n`;
                displayString += `色: ${messageColor}\n`;

                // 各チャンネルごとにタブを生成
                if (!tab_list[channelId]) {
                    tab_list[channelId] = '';
                }
                tab_list[channelId] += `<div style="color:${messageColor}">${displayString}</div>`;

                // 全メッセージに追加
                allMessages += `<div style="color:${messageColor}">${displayString}</div>`;
            });

            // タブごとに内容を表示
            $('#html').html('');  // 既存の内容をクリア
            $('#html').append('<div id="tab-all" class="tab-content active-tab">' + allMessages + '</div>');

            for (const channelId in tab_list) {
                $('#html').append('<div id="tab-' + channelId + '" class="tab-content">' + tab_list[channelId] + '</div>');
                $('#html_selector').append(`
                    <input type="radio" name="html_selector" value="${channelId}" id="tab-${channelId}">
                    <label for="tab-${channelId}">${channelId}</label><br>
                `);
            }

            // 全体表示タブも追加
            $('#html_selector').prepend(`
                <input type="radio" name="html_selector" value="all" id="tab-all" checked>
                <label for="tab-all">全件</label><br>
            `);
        }

        // HTTPリクエストのコールバック処理
        function http_request_callback() {
            const response = this.response;

            // メッセージを格納
            response.documents.forEach(function(doc) {
                message_json.push(doc);
            });

            // 次のページがあるか確認して、再度リクエストを送る
            if (response.nextPageToken) {
                this.open('GET', get_url(current_room_id, response.nextPageToken), true);
                this.responseType = 'json';
                this.send();
            } else {
                // 最後のページに到達したらメッセージを処理
                $('#progress').text('HTML生成中...');
                setTimeout(() => {
                    process_messages(message_json);
                }, 1);
                this.removeEventListener('load', http_request_callback);
            }
        }

        // DOMが準備されたらイベントリスナーを設定
        $(function() {
            $('#get_log').click(function() {
                const startText = $('#text_start').val();
                const endText = $('#text_end').val();

                // 入力チェック
                if (isNaN(Number(startText)) && startText !== '') {
                    alert('開始位置or表示件数の値が無効です');
                    return;
                }
                if (isNaN(Number(endText)) && endText !== '') {
                    alert('終了位置の値が無効です');
                    return;
                }

                $('#progress').text('取得中...');
                current_room_id = $('#room_id').val();
                document.title = current_room_id + ' ccfolia log getter';

                // メッセージデータの初期化
                message_json.splice(0, message_json.length);

                // APIリクエスト
                request.open('GET', get_url(current_room_id), true);
                request.responseType = 'json';
                request.send();

                request.addEventListener('load', http_request_callback);
            });

            // タブ切り替えイベント
            $('#html_selector').on('change', function() {
                const selectedTab = $('input[name="html_selector"]:checked').val();
                $('.tab-content').removeClass('active-tab');
                $('#tab-' + selectedTab).addClass('active-tab');
            });
        });
    </script>
</head>

<body>
    <header style="background: #ffffff; position: fixed;">
        <input type="text" id="room_id" placeholder="ルームIDを入力">
        <input type="text" id="text_start" placeholder="開始位置or表示件数"> -
        <input type="text" id="text_end" placeholder="修了位置">
        <input type="button" id="get_log" value="ログを取得">
        <span id="progress"></span>
        <span id="log_number"></span>
        <form id="html_selector" style="height:50px; overflow: auto;"></form>
    </header>
    
    <div id="html" style="padding-top: 80px;"></div>
    <br>左枠に卓ID、右に表示数を入れてください。
    <br>0で全件表示可能です。
    <br>ver1.12: 開始位置終了位置の指定可、レス番号も表示

</body>

</html>
